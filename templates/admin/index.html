{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load admin_menu %}
{% load leaflet_tags %}

{% block extrastyle %}
{{ block.super }}
<!-- <link rel="stylesheet" type="text/css" href="{% static 'admin/css/dashboard.css' %}" /> -->
{% leaflet_js %}
{% leaflet_css %}
<style type="text/css">
    #map {width: 100%;height: 790px;}
    .leaflet-popup-content {width: 560px! important;}
    /* https://gis.stackexchange.com/questions/327097/how-to-add-top-and-bottom-margins-to-leaflet-popup-with-scroll */
    .custom-popup {
        border-radius: 2px;
        font-family: 'Molengo', sans-serif;
        font-size: 12px;
        line-height: 10px;
        height: 10 px ;
        max-height: 460px;
    }

    .custom-popup, .leaflet-popup-tip {
        background: #e7e7e7;
        border: none;
        box-shadow: none;
    }

    .leaflet-popup-content-wrapper {
        background: #e7e7e7;
        border-radius: 2px;
    }

    .leaflet-popup {
        position: absolute;
        text-align: center;
    }

    .leaflet-popup-content {
        margin-right: 2px;
        padding-right: 12px;
        min-width: 100 px !important;
        max-height: 460px;
        overflow: auto;
    }
    
</style>
<link rel="stylsheet" type="text/css" href="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.css'%}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mwasil/Leaflet.Rainviewer/leaflet.rainviewer.css"/>
<script src="https://cdn.jsdelivr.net/gh/mwasil/Leaflet.Rainviewer/leaflet.rainviewer.js"></script>
<script type="text/javascript" src="{% static 'js/leaflet.markercluster-src.js'%}"></script>
<script type="text/javascript" src="{% static 'js/MarkerCluster.js'%}"></script> 
<script type="text/javascript" src="{% static 'leaflet_dist/leaflet.browser.print.min.js'%}"></script> 
<script type="text/javascript" src="{% static 'leaflet_dist/leaflet.ajax.js'%}"></script>
<script type="text/javascript" src="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.min.js'%}"></script>
<script type="text/javascript" src="{% static 'js/caraga.js' %}"></script>
<script type="text/javascript" src="{% static 'js/major_rivers.js' %}"></script>
<script type="text/javascript" src="{% static 'js/landslide.js' %}"></script>
<script type="text/javascript" src="{% static 'js/barangay.js' %}"></script>
{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}
{% if not is_popup %}
{% block breadcrumbs %}
<div class="row mb-2">
    <div class="col-sm-4">
        <!-- <h2>{{title}}</h2> -->
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#searchModal">
            <i class="fa fa-search"></i> Advance Search
        </button>
        <button type="button" class="btn btn-info" id="btnChart">
            <i class="fas fa-chart-bar"></i> Chart
        </button>
    </div>
    <div class="col-sm-8">
        <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'admin:index' %}"><i class="fas fa-tachometer-alt"></i> {% trans 'Home' %}</a></li>
            {% for app in app_list %}
                <li class="breadcrumb-item active">{{ app.name }}</li>
            {% endfor %}
        </ol>
    </div>
</div>
<div class="row mb-2">
    <div class="col-sm-4 offset-sm-8">
        <div class="row">
            <div class="col-6">
                <input type="text" id="searchInput" class="form-control ml-auto" placeholder="Enter Area Name">
            </div>
            <div class="col-6">
                <button id="searchButton" class="btn btn-primary">Search</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}
{% endif %}

{% block content %}

<!-- INCLUDE -->
{% include 'admin/advance_search.html' %}
{% include 'admin/chart_view.html' %}
<div id="attributeData"></div>


<script type="text/javascript">
    window.addEventListener("map:init", function (e) {

        mymap = event.detail.map;
        
        var households = new L.GeoJSON.AJAX("{% url 'household'%}",{
            pointToLayer: function(feature, latlng) {
                var greenIcon = L.icon({
                    iconUrl: '{% static "image/icons8-green-circle-48.png"%}',

                    iconSize:[16, 16],
                    iconAnchor:[-3,9], // point of the icon which will correspond to marker's location
                    popupAnchor:[0,0],
                    tooltipAnchor:[0,0]
                });
                return L.marker(latlng, {icon: greenIcon}).addTo(markers);
            },
            onEachFeature: function(feature,layer){
                households.on({
                    click:whenClicked
                });            
            }
        });

        function whenClicked(e) {
            // e = event
            // console.log(e.layer.feature.properties.latitude);
            // You can make your ajax call declaration here
            //$.ajax(...     
            $.ajax({
                type: "get",
                url: "{% url 'householdinfo'%}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: {'pk': e.layer.feature.properties.pk} ,
                contentType: 'application/json; charset=utf-8',
                success: function (response) { 
                    var url_mask = "{% url 'admin:household_households_change' object_id='change_id' %}".replace(/change_id/, response[0].controlnumber.toString());


                    function printAvailedprograms(vAvailprograms){
                        
                        var str = "";
                        str += '<div id="myGroup">'; 
                        for(var i=0; i<vAvailprograms.length; i++) {
                            var url_mask_availprograms = "{% url 'admin:household_availprograms_change' object_id='change_id' %}".replace(/change_id/, vAvailprograms[i].id.toString());
                            str += '<li>';
                                str += '<a style="text-transform: capitalize" data-toggle="collapse" href="#availedprogram-'+i+' "aria-expanded="false" aria-controls="collapseExample">';
                                    str += vAvailprograms[i].type_of_program;
                                str += '</a>';
                                str += '</br>';
                                str += '<div class="collapse" id="availedprogram-'+ i +'" data-parent="#myGroup">';
                                    str += '<table class="table table-borderless table-sm" style="margin-left:12px; margin-top:5px;">'
                                        str += '<tbody>';
                                            str += '<tr>';    
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Link for more info:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span><a href="'+url_mask_availprograms+'"> : Click here.</a></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';    
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Name of program:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vAvailprograms[i].name_of_program+'</span></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Number of beneficiaries:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vAvailprograms[i].number_of_beneficiaries+'</span></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Program implementor:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vAvailprograms[i].program_implementor+'</span></td>';                                        
                                            str += '</tr>';                                        
                                        str += '</tbody>';
                                    str += '</table>';    
                                str += '</div>';
                            str += '</li>';
                        }
                        str += '</div> ';

                        return str;
                    }

                    function printFamilies(vFamilies){

                        var str = "";
                        str += '<div id="myGroup">';
                        for(var i=0; i<vFamilies.length; i++) {
                                str += '<a style="text-transform: capitalize" data-toggle="collapse" href="#families-'+i+' "aria-expanded="false" aria-controls="collapseExample">';
                                    str += vFamilies[i].family_head_firstname+' '+ vFamilies[i].family_head_lastname +' '+'- Family Head';
                                str += '</a>';
                                str += '</br>';
                                str += '<div class="collapse" id="families-'+ i +'" data-parent="#myGroup">';
                                    str += '<table class="table table-borderless table-sm" style="margin-left:12px; margin-top:5px;">'
                                        str += '<tbody>';
                                            str += '<tr>';    
                                                str +=    '<td style="width: 25%"><span class="font-weight-bold">Family Status</span></td>';
                                                str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                                str +=    '<td><span>'+ vFamilies[i].status+'</span></td>';                                        
                                                str += '</tr>';
                                            var familyDetails = vFamilies[i].familydetails_set;
                                            if (familyDetails && familyDetails.length > 0) {
                                                for (var j = 0; j < familyDetails.length; j++) {
                                                    str += '<tr>';
                                                    str += '<td style="width: 25%"><span class="font-weight-bold">'+ familyDetails[j].relationship +'</span></td>';
                                                    str += '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                                    str += '<td><span>' + familyDetails[j].fam_member + '</span></td>';
                                                    str += '</tr>';
                                                    // You can add more details here similarly
                                                }
                                            } else {
                                                str += '<tr>';
                                                str += '<td colspan="3">No family details available</td>';
                                                str += '</tr>';
                                            }                                               
                                        str += '</tbody>';
                                    str += '</table>';    
                                str += '</div>';
                            str += '</li>';
                        }
                        str += '</div> ';

                        return str;
                        
                    }
                    
                    function printLivelihoodprograms(vLivelhoods){
                        var str = "";
                        str += '<div id="myGroup">'; 
                        for(var i=0; i<vLivelhoods.length; i++) {
                            var url_mask_livelihoods = "{% url 'admin:household_hhlivelihoods_change' object_id='change_id' %}".replace(/change_id/, vLivelhoods[i].id.toString());
                            str += '<li>';
                                str += '<a style="text-transform: capitalize" data-toggle="collapse" href="#livelihood-'+i+' "aria-expanded="false" aria-controls="collapseExample">';
                                    str += vLivelhoods[i].livelihood;
                                str += '</a>';
                                str += '</br>';
                                str += '<div class="collapse" id="livelihood-'+ i +'" data-parent="#myGroup">';
                                    str += '<table class="table table-borderless table-sm" style="margin-left:12px; margin-top:5px;">'
                                        str += '<tbody>';
                                            str += '<tr>';    
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Link for more info:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span><a href="'+url_mask_livelihoods+'"> : Click here.</a></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';    
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Market value:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vLivelhoods[i].market_value+'</span></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Products:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vLivelhoods[i].products+'</span></td>';                                        
                                            str += '</tr>';
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Area:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vLivelhoods[i].area+'</span></td>';                                        
                                            str += '</tr>'; 
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">Livelihood tenural status:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+vLivelhoods[i].livelihood_tenural_status+'</span></td>';                                        
                                            str += '</tr>';   
                                            str += '<tr>';
                                            str +=    '<td style="width: 25%"><span class="font-weight-bold">With insurance:</span></td>';
                                            str +=    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>';
                                            str +=    '<td><span>'+`${vLivelhoods[0].with_insurance ? 'Yes' : 'No'}`+'</span></td>';                                        
                                            str += '</tr>';                                        
                                        str += '</tbody>';
                                    str += '</table>';    
                                str += '</div>';
                            str += '</li>';
                        }
                        str += '</div> ';

                        return str;
                    }

                    L.popup()
                    .setLatLng(L.latLng(response[0].latitude, response[0].longitude))
                    .setContent('<div class="p-1">'+
                                    '<div class="card card-primary card-outline card-outline-tabs">'+
                                        '<div class="card-header p-0 border-bottom-0">'+
                                            '<ul class="nav nav-tabs" id="custom-tabs-four-tab" role="tablist">'+
                                                '<li class="nav-item">'+
                                                '<a class="nav-link active" id="custom-tabs-four-household-information-tab" data-toggle="pill" href="#custom-tabs-four-household-information" role="tab" aria-controls="custom-tabs-four-household-information" aria-selected="true">Household information</a>'+
                                                '</li>'+
                                                '<li class="nav-item">'+
                                                '<a class="nav-link" id="custom-tabs-four-availed-programs-tab" data-toggle="pill" href="#custom-tabs-four-availed-programs" role="tab" aria-controls="custom-tabs-four-availed-programs" aria-selected="false">Availed programs</a>'+
                                                '</li>'+
                                                '<li class="nav-item">'+
                                                '<a class="nav-link" id="custom-tabs-four-livelihood-tab" data-toggle="pill" href="#custom-tabs-four-livelihood" role="tab" aria-controls="custom-tabs-four-livelihood" aria-selected="false">Livelihood</a>'+
                                                '</li>'+
                                                '<li class="nav-item">'+
                                                '<a class="nav-link" id="custom-tabs-four-families-tab" data-toggle="pill" href="#custom-tabs-four-families" role="tab" aria-controls="custom-tabs-four-families" aria-selected="false">Families</a>'+
                                                '</li>'+
                                            '</ul>'+
                                        '</div>'+
                                    '</div>'+
                                    '<div class="card-body">'+
                                    '<div class="tab-content" id="custom-tabs-four-tabContent">'+
                                        '<div class="tab-pane fade show active" id="custom-tabs-four-household-information" role="tabpanel" aria-labelledby="custom-tabs-four-household-information-tab">'+
                                            '<!-- Household Information -->'+
                                            '<table class="table table-borderless table-sm">'+
                                            '<tbody>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Household ID</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].controlnumber+'<a href="'+url_mask+'"> : Click here for mor info.</a></span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">RESPONDENT</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].respondent+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Municipality</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].municipality+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Barangay</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].barangay+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Purok</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].purok_fk+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Type of building</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].householdbuildingtypes+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Tenural status</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].householdtenuralstatus+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Roof material</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].householdroofmaterials+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Wall material</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].householdwallmaterials+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Water tenural status</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].householdwatertenuralstatus+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Level of water system</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].waterlevelsystems+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Nearest evacuation center</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].evacuationareas+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Building/House construct</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].year_construct+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Estimated cost</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].estimated_cost+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Number of bedrooms</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].number_bedrooms+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Number of storey</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].number_storey+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to electricity</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_electricity ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to internet</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_internet ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Medical treatment</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].medical_treatment == null ? 'Nothing' : `${response[0].medical_treatment}`}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to water supply</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_water_supply ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Water safe to drink</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].potable ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Flood occur in the area</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].floods_occur ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Year flooded</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].year_flooded+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Experience evacuation during calamity</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].experience_evacuate ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Year evacuated</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].year_evacuate+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to health and medical facility</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_health_medical_facility ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to telecommunication</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_telecommuniciation ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Access to drill and simulation</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+`${response[0].access_drill_simulation ? 'Yes' : 'No'}`+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Enumerator</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].enumerator+'</span></td>'+                                            
                                                '</tr>'+
                                                '<tr>'+                                         
                                                    '<td style="width: 25%"><span class="font-weight-bold">Editor</span></td>'+
                                                    '<td style="width: 1%"><span class="font-weight-bold">:</span></td>'+
                                                    '<td><span>'+response[0].editor+'</span></td>'+                                            
                                                '</tr>'+
                                            '</tbody>'+
                                            '</table>'+                          
                                        '</div>'+ 
                                        '<div class="tab-pane fade" id="custom-tabs-four-availed-programs" role="tabpanel" aria-labelledby="custom-tabs-four-availed-programs-tab">'+
                                            '<!-- Foldable list of availed programs -->'+
                                            printAvailedprograms(response[0].availprograms_set)+
                                        '</div>'+
                                        '<div class="tab-pane fade" id="custom-tabs-four-livelihood" role="tabpanel" aria-labelledby="custom-tabs-four-livelihood-tab">'+
                                            '<!-- Foldable list of livelihood -->'+    
                                            printLivelihoodprograms(response[0].hhlivelihoods_set)+                             
                                        '</div>'+
                                        '<div class="tab-pane fade" id="custom-tabs-four-families" role="tabpanel" aria-labelledby="custom-tabs-four-families-tab">'+
                                            '<!-- Foldable list of families -->'+    
                                            printFamilies(response[0].families_set)+                             
                                        '</div>'+
                                    '</div>'+
                                    '</div>'+
                                '</div>',{
                                    maxWidth: 560,
                                    maxHeight: 460,

                                })
                    .openOn(mymap);

                },
            });
        }

        //Cluster Markers
        var markers = L.markerClusterGroup({
            maxClusterRadius: 35,
            spiderfyOnMaxZoom: false, // Disable spiderfy on max zoom
            showCoverageOnHover: false, // Disable showing coverage on hover
            //zoomToBoundsOnClick: true, // Enable zoom to bounds on click
            disableClusteringAtZoom: 18// Set the max zoom level to disable clustering
        });
       
      
        markers.addLayer(households);
        mymap.addLayer(markers);
        var Major_Rivers = L.geoJson(major_rivers)
        var Landslide = L.geoJson(landslide, {
            style: {
                color: '#e60000'
            }
        })
        var Barangay = L.geoJson(barangay)


        //BaseMaps
        var mapboxSatellite = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            accessToken: 'pk.eyJ1IjoiaWFtdGVrc29uIiwiYSI6ImNqdjV4YzI4YjB0aXk0ZHBtNnVnNWxlM20ifQ.FjQJyCTodXASYtOK8IrLQA',
            maxZoom: 20
          }).addTo(mymap);

        var mapbox = L.tileLayer('https://api.tiles.mapbox.com/styles/v1/{username}/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            username: 'iamtekson',
            id: 'cjwhym7s70tae1co8zf17a3r5',
            accessToken: 'pk.eyJ1IjoiaWFtdGVrc29uIiwiYSI6ImNqdjV4YzI4YjB0aXk0ZHBtNnVnNWxlM20ifQ.FjQJyCTodXASYtOK8IrLQA'
        });

        var CartoDB_Voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });

        var CartoDB_DarkMatter =  L.tileLayer('https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.jpg?key=kEDERnHNlZLDljPBkGDv', {
            attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> contributors',
            maxZoom: 20
        });
            
        
        households.on('data:loaded', function() {
            if(households.getBounds().isValid())
                mymap.fitBounds(households.getBounds());
        });

        var baseMaps = {
            "MapboxSatellite": mapboxSatellite,
            "Mapbox V1": mapbox,
            "CartoDB Voyager":CartoDB_Voyager,
            "CartoDB_DarkMatter": CartoDB_DarkMatter,  
        };

        var groupedOverlays = {
            "Overlays": {
                "Households": markers,
                "Barangay": Barangay,
                "Major Rivers": Major_Rivers,
                "Landslide": Landslide
    
            }
            //"Evacuation Center": evacuation_center
        };
       
        L.control.groupedLayers(baseMaps, groupedOverlays).addTo(mymap);
        var browserPrint = L.browserPrint(mymap,{debug:false, cancelWithEsc: true});
        var c = L.control.browserPrint({
            printModes: [
                L.BrowserPrint.Mode.Landscape(),
                L.BrowserPrint.Mode.Landscape('A4',{margin: 0, title: 'Header / Footer', header: {
                    enabled: true,
                    text: "<span>A wonderful print Plugin</span>",
                    size: "10mm",
                    overTheMap: false,
                },
                footer: {
                    enabled: true,
                    text: "<span>Created by PDRRMO-ADN</span>",
                    size: "8mm",
                    overTheMap: false,
                }
            }), L.BrowserPrint.Mode.Custom("A4", {title: "Select area (Custom)"})]
        }, browserPrint).addTo(mymap);

        
        // We are not cloning markercluster to preserve original clasterization behavior and prevent OutOfMemory problems
        L.BrowserPrint.Utils.registerLayer(L.MarkerClusterGroup, 'L.MarkerClusterGroup', function (layer, utils) {
            var cluster = L.markerClusterGroup(layer._group.options);
            cluster.addLayers(utils.cloneInnerLayers(layer._group));
            return cluster;
        });

        // On print end we invalidate markercluster to update markers;
        mymap.on(L.BrowserPrint.Event.PrintEnd, function (e) {
            mymap.removeLayer(markers);
            mymap.addLayer(markers);
        });
            // Change default options
        L.control.rainviewer({ 
            position: 'bottomleft',
            nextButtonText: '>',
            playStopButtonText: 'Play/Stop',
            prevButtonText: '<',
            positionSliderLabelText: "Hour:",
            opacitySliderLabelText: "Opacity:",
            animationInterval: 500,
            opacity: 0.5
        }).addTo(mymap);


        // Create an empty GeoJSON layer
        var geoJSONLayer = L.geoJSON().addTo(mymap);

        // Function to add a GeoJSON feature to the layer
        function addGeoJSONFeature(feature) {
            geoJSONLayer.addData(feature);
        }

        $(document).ready(function () {
            $('#searchButton').click(function () {
                var placeName = $('#searchInput').val().trim().toLowerCase();
        
                // Clear layers
                markers.clearLayers();
                geoJSONLayer.clearLayers();
        
                // Collect matching features
                var matchingFeatures = [];
                barangay.features.forEach(function (feature) {
                    var featurePlaceName = feature.properties.BarangayNa.toLowerCase();
                    if (featurePlaceName === placeName) {
                        matchingFeatures.push(feature);
                    }
                });
        
                // Add matching features to the layer
                if (matchingFeatures.length > 0) {
                    geoJSONLayer.addData(matchingFeatures);
                    mymap.fitBounds(geoJSONLayer.getBounds());
        
                    // Perform AJAX request
                    $.ajax({
                        type: 'POST',
                        url: "{% url 'search_view' %}",  // Replace with the actual URL of your Django view
                        data: {
                            'search_input': placeName,
                            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                        },
                        dataType: 'json',
                        success: function (data) {
                            var matchingFeature = geoJSONLayer.getLayers()[0];
        
                            if (matchingFeature) {
                                if ('matching_reports' in data && data.matching_reports.length > 0) {
                                    var report = data.matching_reports[0];
                                    var popupContent =
                                    '<div class="custom-popup" style="line-height: 1.2;">' +
                                    '<h2 style="margin-bottom: 8px;">Household Affected by Storm Surge</h2>' +
                                    '<p style="margin-bottom: 4px;"><strong>Municipality Name:</strong> ' + report.municipality_name + '</p>' +
                                    '<p style="margin-bottom: 4px;"><strong>Barangay Name:</strong> ' + report.barangay_name + '</p>' +
                                    '<p style="margin-bottom: 4px;"><strong>Total:</strong> ' + data.total_households + '</p>' +
                                    '</div>';
                                
        
                                    matchingFeature.bindPopup(popupContent,{
                                        maxWidth: 200,
                                    }).openPopup();
                                } else if ('message' in data) {
                                    var popupContent =
                                        '<div class="custom-popup">' +
                                        '<h2>' + data.message + '</h2>' +
                                        '</div>';
                                    matchingFeature.bindPopup(popupContent).openPopup();
                                }
                            }
                        },
                        error: function (error) {
                            console.log('Error:', error);
                        }
                    });
                }
            });
        });
        
        

        $( "#advance_search" ).click(function() {          
            /* Get from elements values */
            var values = $('#advance_search_form').serialize();
          
            $.ajax({
                type: "get",
                url: "{% url 'household'%}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: values ,
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                        //Clear old layer
                        markers.clearLayers();

                       //Load The GeoJSON layer using Leaflet GeoJSON method 
                        var households = new L.GeoJSON(response,{
                            pointToLayer: function(feature, latlng) {
                                var greenIcon = L.icon({
                                    iconUrl: '{% static "image/icons8-green-circle-48.png"%}',
                                    iconSize:     [16, 16],
                                    iconAnchor:   [-3,9], // point of the icon which will correspond to marker's location
                                    popupAnchor: [0,0],
                                    tooltipAnchor: [0,0]
                                });
                                return L.marker(latlng, {icon: greenIcon});
                            },
                        }).on('click',function(e){
                            whenClicked(e)
                        });
                        //fit Bounds
                        if(households.getBounds().isValid())
                            mymap.fitBounds(households.getBounds());   
       
                        // update layer group with the new point Layer
                        markers.addLayer(households);

                },
            });

            
        });     

       
        $( "#btnChart" ).click(function() {
            $('#graphsModal').modal('toggle');
            var values = $('#advance_search_form').serialize();

            $.ajax({
                type: "POST",
                url: "{% url 'household_chart'%}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: values ,
                success: function (response) {

                    $("#chart_view").html(response);

                },
            });

            
        });
    
    }, false);
</script>
{% leaflet_map "map" %}
{% endblock %}
